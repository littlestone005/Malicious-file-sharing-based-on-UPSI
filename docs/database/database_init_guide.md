# 数据库初始化与重置指南

本文档提供有关如何使用数据库初始化脚本的详细说明，特别是如何将数据库重置回初始状态。

## 概述

`tools/init_db.py` 脚本用于初始化或重置项目的数据库，它会：

1. 自动创建数据库表结构（如果不存在）
2. 添加初始用户账号（包括预设密码）
3. 添加初始恶意软件特征数据
4. 添加示例扫描记录

这个脚本特别适合以下场景：
- 首次设置项目时初始化数据库
- **项目展示后重置数据库**（恢复所有用户密码和删除新增数据）
- 测试环境中快速准备初始数据

## 使用方法

### 基本初始化

如果数据库不存在，在项目根目录下运行：

```bash
python tools/init_db.py
```

执行此命令后，脚本将：
- 检查数据库是否已存在
- 如果数据库不存在，创建所有必要的表并添加初始数据
- 如果数据库已存在，询问是否继续初始化（这不会删除现有数据）

### 完全重置数据库

**重要功能：** 在项目展示结束后，当数据库中可能有用户添加/修改过的数据，可以使用此选项重置到原始状态。

使用 `--force` 选项可以完全重置数据库到初始状态：

```bash
python tools/init_db.py --force
```

此命令将：
- 删除数据库中的所有现有表和数据
- 重新创建表结构
- 重新添加所有初始数据
- 恢复所有原始用户密码

**适用场景：**
- 项目演示后需要重置为原始状态
- 某些用户修改了密码后需要恢复
- 数据库中添加了过多测试数据需要清理
- 准备下一轮展示或演示前的环境重置

## 初始数据内容

重置后的数据库将包含以下初始数据：

### 1. 用户账号

将重置为以下两个默认用户账号：

| 用户名 | 密码 | 邮箱 | 角色 |
|-------|------|------|------|
| admin | admin | admin@example.com | 管理员 |
| testuser | test123 | test@example.com | 普通用户 |

### 2. 恶意软件特征

包含5条初始恶意软件特征，包括：
- Trojan类型 (高危)
- Ransomware类型 (严重)
- Spyware类型 (中危)
- Adware类型 (低危)
- Worm类型 (中危)

### 3. 扫描记录

包含两条示例扫描记录：
- 一条安全文件的扫描记录（归属于admin用户）
- 一条恶意文件的扫描记录（归属于testuser用户）

## 数据库位置

默认情况下，数据库文件位于项目的 `data/malware_detection.db` 路径下。

## 常见问题与解决办法

### 1. 忘记管理员密码

如果在项目展示过程中管理员密码被修改且无法登录，可以使用以下命令重置：

```bash
python tools/init_db.py --force
```

执行后，admin用户的密码将恢复为"admin"。

### 2. 数据库出现异常

如果数据库出现异常状态或数据损坏，可以使用强制重置功能恢复：

```bash
# 先删除数据库文件
rm data/malware_detection.db*
# 然后重新初始化
python tools/init_db.py
```

### 3. 其他故障排除

如果在运行脚本时遇到问题：

1. 确保已安装所有依赖：
   ```bash
   pip install -r requirements.txt
   ```

2. 确保在项目根目录下运行该脚本

3. 检查日志输出以获取详细的错误信息 