# 项目设计说明

本文档介绍基于UPSI的恶意文件检测系统的设计思路和核心技术亮点。

## 系统架构

该系统由三个主要部分组成:

1. **前端**: 基于React和Ant Design构建的用户界面，提供文件上传、结果展示和用户管理功能
2. **后端**: 使用FastAPI实现的API服务，处理请求、业务逻辑和数据管理
3. **算法模块**: 高效的私有集合交集(PSI)算法实现，为隐私保护恶意软件检测提供核心支持

## 技术亮点

### 隐私保护的PSI算法

系统采用非平衡PSI（Private Set Intersection）协议实现隐私保护的恶意文件检测：

- **工作原理**：允许两方（用户和检测服务器）在不泄露各自集合元素的前提下计算集合交集
- **关键技术**：
  - 混淆电路(Garbled Circuit)技术构建安全计算环境
  - 不经意传输(Oblivious Transfer)协议安全交换数据
  - Bloom过滤器预处理以提高效率
  - 批量处理和哈希桶分区减少计算复杂度
- **隐私保护级别**：支持三种隐私级别（低、中、高），提供不同程度的隐私保护和性能平衡

### 高效的后端服务

基于FastAPI构建的高性能异步API服务：

- **API设计**：RESTful API设计，清晰的资源划分和操作定义
- **安全机制**：
  - JWT认证保护API访问
  - 密码安全存储（哈希加盐）
  - 资源授权控制
- **数据库架构**：
  - 使用SQLAlchemy ORM管理实体关系
  - 优化的数据结构设计
  - 事务管理确保数据一致性
- **并发处理**：异步处理用户请求，提高系统吞吐量

### 用户友好的前端界面

基于React和Ant Design构建的现代化UI：

- **技术栈**：
  - React用于UI构建
  - Ant Design提供UI组件库
  - React Router实现路由管理
  - Axios处理API请求
  - Styled Components处理样式
- **用户体验设计**：
  - 简洁直观的界面设计
  - 视觉反馈增强用户操作体验
  - 响应式设计适配不同设备
- **功能模块**：
  - 文件上传组件支持拖放功能
  - 实时扫描进度显示
  - 详细的威胁评估结果展示
  - 用户账户和设置管理

## 数据流程

系统的主要数据流程如下：

1. **用户文件上传**：
   - 前端验证文件类型和大小
   - 加密传输到后端服务器

2. **特征提取**：
   - 后端从文件中提取关键特征
   - 特征包括：字节直方图、熵、PE头部信息等

3. **隐私保护检测**：
   - 使用PSI协议比较用户文件特征和已知恶意软件特征
   - 不泄露完整特征信息，只获取匹配结果

4. **结果分析与展示**：
   - 后端整合检测结果
   - 前端展示友好的分析报告
   - 提供安全建议和可能的处理方法

## 安全考量

系统在设计和实现过程中注重以下安全方面：

1. **数据安全**：
   - 所有传输通过HTTPS加密
   - 敏感信息（如密码）不以明文存储
   - 用户上传的文件仅在内存中处理，不保存原始内容

2. **隐私保护**：
   - PSI协议确保用户文件特征和服务端恶意软件特征库互不泄露
   - 用户可选择不同级别的隐私保护模式
   - 支持匿名模式扫描不留下记录

3. **系统安全**：
   - API访问限制和速率控制
   - 文件类型验证防止恶意上传
   - 定期更新和维护安全措施

## 扩展性设计

系统设计考虑了未来的扩展需求：

1. **算法模块扩展**：
   - 模块化的PSI实现，支持更新协议版本
   - 可插拔的特征提取器支持更多类型的文件分析

2. **后端服务扩展**：
   - 微服务架构便于横向扩展
   - 资源隔离和负载均衡
   - 插件系统支持功能扩展

3. **前端功能扩展**：
   - 组件化设计支持UI定制和功能添加
   - 国际化支持多语言
   - 主题系统支持UI风格定制

## 未来展望

计划在未来版本中添加的功能和改进：

1. **功能增强**：
   - 支持更多文件类型的分析
   - 添加实时威胁情报集成
   - 提供高级威胁分析报告

2. **性能优化**：
   - 进一步优化PSI协议效率
   - 改进特征提取算法
   - 实现分布式处理大量文件

3. **用户体验改进**：
   - 移动设备适配优化
   - 更直观的可视化报告
   - 更多语言的国际化支持

## 系统架构

### 前端（客户端）
用户交互界面，用于文件上传、结果显示、隐私协议确认。

**前端核心功能**：
1. 文件上传：支持拖拽或选择文件，自动计算哈希值（如SHA-256）
2. 隐私设置：让用户选择是否启用PSI协议（对比传统非隐私模式）
3. 结果展示：高亮显示恶意文件，提供详细信息（如威胁类型、来源）

**交互风格**：
- 安全感知设计：使用盾牌、锁图标等元素强化隐私保护感
- 极简流程：三步完成上传→检测→结果

### 后端（服务端）
处理业务逻辑，协调算法模块与数据库。

**核心功能**：
- 协议调度：协调客户端请求与算法模块的PSI协议执行
- 结果缓存：对重复查询的文件哈希进行缓存，减少计算开销
- 访问控制：基于API Key或OAuth2.0限制服务调用权限

**技术栈**：FastAPI（Python），配合gRPC实现算法模块通信

### 算法模块
实现非平衡PSI协议（核心创新点），包括服务端预处理、客户端查询、结果验证。

**核心功能**：
- 服务端预处理：对恶意特征库进行OPRF（不经意伪随机函数）编码，生成预计算数据
- 客户端查询：执行PSI协议，仅返回交集结果（即匹配的恶意文件）
- 恶意安全扩展：集成零知识证明（如zk-SNARKs）验证服务端行为合法性

**技术栈**：C++（性能关键部分），调用密码学库（如OpenSSL、libsodium）

### 数据库
存储服务端的恶意文件特征库（如哈希值、元数据）。
- 使用Redis（高性能内存数据库）
- 使用MySQL/SQLite数据库记录审计日志或用户行为

### 辅助工具链
数据预处理脚本（如文件→哈希转换）、性能监控工具

## 界面设计

### 视觉风格
- 主色调：深蓝色（象征安全）+ 绿色（安全状态）+ 红色（危险警告）
- 动态效果：文件上传时的加密动画（如粒子消散效果），增强"隐私保护"感知
- 数据可视化：使用ECharts展示检测结果统计（如恶意文件占比、类型分布）

### 安全提示设计
- 用户上传文件前，强制阅读隐私协议摘要（如"您的文件哈希将被加密，服务端无法查看其他内容"）
- 检测结果页显示"隐私保护徽章"（如锁型图标 + "本次检测未泄露非恶意文件信息"）

### 响应式设计
支持桌面端和移动端自适应布局，重点优化移动端上传流程

## 架构示意图

```
+----------------+       +----------------+       +----------------+
|    客户端       |       |    服务端       |       |    数据库       |
| (浏览器/移动端) |<----->| (Python/Go)    |<----->| (MySQL/Redis)  |
+----------------+       +----------------+       +----------------+
      ↑                         ↑
      | 文件上传/结果展示        | 调用算法模块
+----------------+       +----------------+
| 前端界面        |       | PSI算法引擎     |
| (React/Vue)    |       | (C++/Rust)     |
+----------------+       +----------------+
```

## API接口设计

### 客户端-服务端接口（RESTful API）

**文件检测接口**：
- Endpoint: `/api/v1/detect`
- Method: POST
- Request Body:
```json
{
  "client_id": "USER_123",
  "hashes": ["a1b2c3...", "d4e5f6..."],  // 客户端文件哈希列表
  "use_psi": true  // 是否启用隐私检测模式
}
```
- Response:
```json
{
  "malicious_hashes": ["d4e5f6..."],  // 匹配的恶意哈希
  "proof": "zkp_base64_string"        // 可选的零知识证明
}
```

### 算法模块接口（内部gRPC）

**PSI协议执行接口**：
- Service: PSIService
- RPC Method: ExecutePSI
- Request/Response:
```protobuf
message PSIRequest {
  repeated string client_hashes = 1;
  bytes server_preprocessed = 2;  // 服务端预计算数据
}

message PSIResponse {
  repeated string intersection = 1;
  bytes zkp_proof = 2;           // 结果正确性证明
}
```

### 管理端接口

**恶意特征库更新接口**：
- Endpoint: `/api/v1/admin/update_malicious`
- Method: POST
- 权限：JWT Token + IP白名单
- 功能：允许管理员批量添加/删除恶意文件特征

## 部署方案

### 本地开发环境
- 使用Docker Compose部署服务端、数据库、算法模块
- 前端通过Vite本地开发服务器运行

### 生产环境
- 服务端：Kubernetes集群（支持水平扩展）
- 算法模块：独立部署在具备GPU的节点（加速OPRF计算）
- 数据库：Redis Cluster分片存储恶意特征库

### 监控与日志
- Prometheus + Grafana监控API性能（QPS、延迟）
- ELK（Elasticsearch, Logstash, Kibana）收集错误日志

## 安全防护设计

- 传输层：全链路HTTPS + 双向mTLS认证
- 输入校验：严格限制哈希格式（如长度64的十六进制字符串）
- 防滥用机制：客户端请求限流（如每分钟10次检测）
- 算法侧防护：防止恶意客户端发送超大请求耗尽服务端资源

## 项目总结

### 用户视角
一个类似VirusTotal的网站，但上传文件时多了一个"隐私模式"开关。

### 技术视角
后端隐藏着一个高性能的非平衡PSI引擎，与传统方案相比，通信量降低80%。

### 创新点展示
在界面上对比"启用PSI"和"传统模式"的隐私性差异（如显示服务端可获取的信息量）。

---
**注意**：本文档仅为项目初期构思笔记，实际实现可能有所不同。 