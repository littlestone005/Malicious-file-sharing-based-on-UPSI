/**
 * 恶意软件上传页面组件
 * 
 * 这个组件实现了恶意软件样本上传功能，主要用于演示：
 * 1. 文件上传
 * 2. 恶意软件元数据录入
 * 3. 添加到已知威胁数据库中
 * 
 * 注意：此页面仅限管理员用户访问
 */

import React, { useState, useContext, useEffect } from 'react';
import { 
  Typography, 
  Card, 
  Upload, 
  Button, 
  Form, 
  Input, 
  Select, 
  Alert, 
  Spin, 
  message, 
  Space,
  Result 
} from 'antd';
import { 
  UploadOutlined, 
  BugOutlined, 
  WarningOutlined, 
  InfoCircleOutlined, 
  LockOutlined,
  ExclamationCircleOutlined
} from '@ant-design/icons';
import styled from 'styled-components';
import { UserContext } from '../App';
import { scanAPI } from '../utils/api';
import { useNavigate } from 'react-router-dom';

const { Title, Paragraph, Text } = Typography;
const { Option } = Select;
const { TextArea } = Input;
const { Dragger } = Upload;

// 页面容器样式
const PageContainer = styled.div`
  max-width: 800px;
  margin: 0 auto;
`;

// 上传表单卡片样式
const UploadCard = styled(Card)`
  margin-top: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
`;

// 警告框样式
const WarningBox = styled(Alert)`
  margin-bottom: 20px;
`;

// 恶意软件上传页面组件
const MalwareUploadPage = () => {
  const { user } = useContext(UserContext);
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [fileList, setFileList] = useState([]);
  const [loading, setLoading] = useState(false);
  const [uploadSuccess, setUploadSuccess] = useState(false);
  const [uploadedData, setUploadedData] = useState(null);
  
  // 检查用户权限
  useEffect(() => {
    if (!user) {
      message.error('请先登录');
      navigate('/');
    } else if (user.username !== 'admin') {
      message.error('只有管理员可以访问此页面');
      navigate('/');
    }
  }, [user, navigate]);
  
  // 处理文件上传前的验证
  const beforeUpload = (file) => {
    // 更新文件列表，限制只能有一个文件
    setFileList([file]);
    return false; // 阻止自动上传
  };
  
  // 处理表单提交
  const handleSubmit = async (values) => {
    if (fileList.length === 0) {
      message.error('请选择要上传的文件');
      return;
    }
    
    const file = fileList[0];
    
    // 表单数据
    const formData = {
      threatType: values.threat_type,
      severity: values.severity,
      description: values.description
    };
    
    setLoading(true);
    
    try {
      // 调用API上传恶意软件样本
      const response = await scanAPI.uploadMalwareSample(file, formData);
      
      if (response) {
        message.success('成功上传恶意软件样本');
        setUploadSuccess(true);
        setUploadedData(response);
        
        // 重置表单和文件列表
        form.resetFields();
        setFileList([]);
      }
    } catch (error) {
      console.error('上传失败:', error);
      
      let errorMsg = '上传失败，请重试';
      if (error.response) {
        if (error.response.status === 403) {
          errorMsg = '权限不足，只有管理员可以上传恶意软件样本';
        } else if (error.response.data && error.response.data.detail) {
          errorMsg = error.response.data.detail;
        }
      }
      
      message.error(errorMsg);
    } finally {
      setLoading(false);
    }
  };
  
  // 文件上传组件的props
  const uploadProps = {
    name: 'file',
    beforeUpload,
    fileList,
    multiple: false,
    maxCount: 1,
    onRemove: () => {
      setFileList([]);
    },
  };
  
  // 如果用户未登录或不是admin，显示空页面（useEffect会处理重定向）
  if (!user || user.username !== 'admin') {
    return null;
  }
  
  return (
    <PageContainer>
      <Title level={2}>
        <BugOutlined /> 恶意软件样本上传
      </Title>
      
      <Paragraph>
        此页面用于上传恶意软件样本，所有上传的文件都将被添加到已知威胁数据库中，以用于后续的演示。
        <Text type="danger" strong> 注意：此功能仅供演示使用，请勿上传真正的恶意软件。</Text>
      </Paragraph>
      
      <WarningBox
        message="管理员专用功能"
        description="此功能仅限管理员使用，上传的文件将被标记为恶意软件以用于演示。"
        type="warning"
        showIcon
        icon={<ExclamationCircleOutlined />}
      />
      
      {uploadSuccess ? (
        // 上传成功后显示结果
        <Result
          status="success"
          title="恶意软件样本上传成功"
          subTitle={`文件"${uploadedData?.file_name || ''}"已成功添加到已知威胁数据库`}
          extra={[
            <Button 
              type="primary" 
              key="upload-again" 
              onClick={() => setUploadSuccess(false)}
            >
              继续上传
            </Button>,
            <Button 
              key="scan" 
              onClick={() => navigate('/scan')}
            >
              进行扫描
            </Button>
          ]}
        />
      ) : (
        // 上传表单
        <UploadCard>
          <Form
            form={form}
            layout="vertical"
            onFinish={handleSubmit}
            disabled={loading}
          >
            {/* 文件上传 */}
            <Form.Item
              label="选择文件"
              name="file"
              rules={[{ required: true, message: '请选择要上传的文件' }]}
            >
              <Dragger {...uploadProps}>
                <p className="ant-upload-drag-icon">
                  <UploadOutlined />
                </p>
                <p className="ant-upload-text">点击或拖拽文件到此区域上传</p>
                <p className="ant-upload-hint">
                  所有上传的文件都将被标记为恶意软件以用于演示。请勿上传真正的恶意软件。
                </p>
              </Dragger>
            </Form.Item>
            
            {/* 威胁类型 */}
            <Form.Item
              label="威胁类型"
              name="threat_type"
              rules={[{ required: true, message: '请选择威胁类型' }]}
            >
              <Select placeholder="选择恶意软件类型">
                <Option value="Virus">病毒 (Virus)</Option>
                <Option value="Trojan">特洛伊木马 (Trojan)</Option>
                <Option value="Ransomware">勒索软件 (Ransomware)</Option>
                <Option value="Spyware">间谍软件 (Spyware)</Option>
                <Option value="Adware">广告软件 (Adware)</Option>
                <Option value="Rootkit">根套件 (Rootkit)</Option>
                <Option value="Worm">蠕虫 (Worm)</Option>
                <Option value="Backdoor">后门 (Backdoor)</Option>
                <Option value="Malicious_Document">恶意文档 (Malicious Document)</Option>
                <Option value="Other">其他恶意软件 (Other)</Option>
              </Select>
            </Form.Item>
            
            {/* 威胁严重性 */}
            <Form.Item
              label="威胁级别"
              name="severity"
              rules={[{ required: true, message: '请选择威胁级别' }]}
            >
              <Select placeholder="选择威胁级别">
                <Option value="low">低 (Low)</Option>
                <Option value="medium">中 (Medium)</Option>
                <Option value="high">高 (High)</Option>
                <Option value="critical">严重 (Critical)</Option>
              </Select>
            </Form.Item>
            
            {/* 威胁描述 */}
            <Form.Item
              label="威胁描述"
              name="description"
            >
              <TextArea 
                rows={4} 
                placeholder="请简要描述该恶意软件的特性和危害(可选)"
              />
            </Form.Item>
            
            {/* 提交按钮 */}
            <Form.Item>
              <Space>
                <Button 
                  type="primary" 
                  htmlType="submit"
                  loading={loading}
                  icon={<BugOutlined />}
                >
                  上传恶意软件样本
                </Button>
                <Button 
                  type="default"
                  onClick={() => navigate('/')}
                >
                  取消
                </Button>
              </Space>
            </Form.Item>
          </Form>
        </UploadCard>
      )}
    </PageContainer>
  );
};

export default MalwareUploadPage; 